---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Welcome to Astro.">
	<main>
		<div id="color-grid" class="color-grid"></div>
	</main>
</Layout>

<script>
// Configuration
const ITEM_SIZE = 24; // Width & height of each color box
const TOTAL_COLORS = 16777216; // 256^3
const COLUMNS = Math.floor(window.innerWidth / ITEM_SIZE);
const ROWS = Math.ceil(TOTAL_COLORS / COLUMNS);

// Pre-compute hex lookup for 0-255
const HEX = Array.from({ length: 256 }, (_, i) => i.toString(16).padStart(2, '0').toUpperCase());

// State
let scrollRow = 0;
let isScrolling = false;
let scrollTimeout: number;

// DOM refs
const grid = document.getElementById('color-grid') as HTMLElement;
const lcg = document.getElementById('lcg');
const ncg = document.getElementById('ncg');
const ncl = document.getElementById('ncl');
const tlEl = document.getElementById('tl');

// Calculate color from index (optimized)
function indexToHex(index: number): string {
	const r = Math.floor(index / 65536) % 256;
	const g = Math.floor(index / 256) % 256;
	const b = index % 256;
	return `#${HEX[r]}${HEX[g]}${HEX[b]}`;
}

// Setup virtualized grid
function initVirtualGrid(): void {
	const viewportHeight = window.innerHeight;
	const visibleRows = Math.ceil(viewportHeight / ITEM_SIZE) + 4; // Buffer

	// Set total scroll height
	grid.style.height = `${ROWS * ITEM_SIZE}px`;

	// Create visible elements pool (reusable)
	const fragment = document.createDocumentFragment();
	const pool: HTMLDivElement[] = [];

	for (let i = 0; i < visibleRows * COLUMNS; i++) {
		const box = document.createElement('div');
		box.className = 'color-box';
		box.style.cssText = `width:${ITEM_SIZE}px;height:${ITEM_SIZE}px;position:absolute;`;
		fragment.appendChild(box);
		pool.push(box);
	}
	grid.appendChild(fragment);

	// Event delegation for clicks
	grid.addEventListener('click', (e) => {
		const target = e.target as HTMLElement;
		if (target.classList.contains('color-box')) {
			const hex = target.dataset.hex;
			if (hex) {
				navigator.clipboard.writeText(hex).catch(console.error);
			}
		}
	});

	// Render function - updates existing nodes
	function render(): void {
		const startRow = Math.max(0, scrollRow - 2);
		const endRow = Math.min(ROWS, startRow + visibleRows);

		let poolIndex = 0;
		for (let row = startRow; row < endRow; row++) {
			for (let col = 0; col < COLUMNS; col++) {
				const index = row * COLUMNS + col;
				if (index >= TOTAL_COLORS) break;

				const box = pool[poolIndex++];
				const hex = indexToHex(index);

				box.style.transform = `translate(${col * ITEM_SIZE}px, ${row * ITEM_SIZE}px)`;
				box.style.backgroundColor = hex;
				box.textContent = '';
				box.dataset.hex = hex;
			}
		}

		// Update stats
		const currentIndex = scrollRow * COLUMNS;
		if (lcg) lcg.textContent = indexToHex(currentIndex);
		if (ncg) ncg.textContent = String(currentIndex);
		if (ncl) ncl.textContent = String(TOTAL_COLORS - currentIndex);
	}

	// Scroll handler
	function onScroll(): void {
		scrollRow = Math.floor(window.scrollY / ITEM_SIZE);

		// Throttle rendering
		if (!isScrolling) {
			isScrolling = true;
			requestAnimationFrame(() => {
				render();
				isScrolling = false;
			});
		}

		// Update ETA less frequently
		clearTimeout(scrollTimeout);
		scrollTimeout = setTimeout(() => {
			const remaining = TOTAL_COLORS - scrollRow * COLUMNS;
			const rate = 50000; // Approximate scroll rate
			if (tlEl) tlEl.textContent = formatTime(remaining / rate);
		}, 100);
	}

	// Skip to bottom button
	document.getElementById('skiptobutton')?.addEventListener('click', () => {
		window.scrollTo({ top: document.body.scrollHeight });
	});

	window.addEventListener('scroll', onScroll, { passive: true });
	render();
}

function formatTime(seconds: number): string {
	const days = Math.floor(seconds / 86400);
	const hours = Math.floor((seconds % 86400) / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	const secs = Math.floor(seconds % 60);
	return `${String(days).padStart(2, '0')}:${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

initVirtualGrid();
</script>

<style>
	.color-grid {
		position: relative;
		width: 100%;
	}

	.color-box {
		box-sizing: border-box;
		font-size: 8px;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		transition: transform 0s;
	}

	.color-box:hover {
		outline: 2px solid white;
		z-index: 1;
	}
</style>
