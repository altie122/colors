---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Welcome to Astro.">
	<main>
		<div id="color-container"></div>
	</main>
</Layout>

<script>
// Pre-compute hex lookup for 0-255 (faster than function calls)
const HEX = Array.from({ length: 256 }, (_, i) =>
	i.toString(16).padStart(2, '0').toUpperCase()
);

// Cache DOM elements once
const container = document.getElementById('color-container')!;
const lcg = document.getElementById('lcg');
const ncg = document.getElementById('ncg');
const ncl = document.getElementById('ncl');
const tlEl = document.getElementById('tl');

// State
const TOTAL_COLORS = 16777216;
const BATCH_SIZE = 300;
const VISIBLE_THRESHOLD = 1000; // Max visible elements before virtualizing

let generatedCount = 0;
let isComplete = false;
let scrollTarget: number | null = null;

// Stats tracking
const rateHistory: number[] = [];
const smoothingFrames = 30;

// Fast index to hex conversion
function indexToHex(index: number): string {
	return `#${HEX[(index >> 16) & 255]}${HEX[(index >> 8) & 255]}${HEX[index & 255]}`;
}

// Event delegation - single click handler for all color boxes
container.addEventListener('click', (e) => {
	const target = e.target as HTMLElement;
	if (target.classList.contains('color-box')) {
		const hex = target.dataset.hex;
		if (hex) {
			navigator.clipboard.writeText(hex).catch(console.error);
			// Visual feedback
			target.style.outline = '2px solid white';
			setTimeout(() => (target.style.outline = ''), 200);
		}
	}
});

// Skip to bottom handler
document.getElementById('skiptobutton')?.addEventListener('click', () => {
	scrollTarget = document.body.scrollHeight;
	window.scrollTo({ top: scrollTarget });
});

function formatTime(seconds: number): string {
	const days = Math.floor(seconds / 86400);
	const hours = Math.floor((seconds % 86400) / 3600);
	const minutes = Math.floor((seconds % 3600) / 60);
	const secs = Math.floor(seconds % 60);
	return `${String(days).padStart(2, '0')}:${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

// Virtualize old elements when too many exist
function cleanupOldElements(): void {
	const boxes = container.querySelectorAll('.color-box');
	if (boxes.length > VISIBLE_THRESHOLD) {
		// Remove oldest elements (keep most recent)
		const removeCount = boxes.length - VISIBLE_THRESHOLD + 200;
		for (let i = 0; i < removeCount; i++) {
			boxes[i].remove();
		}
	}
}

function generateColors(): void {
	const start = performance.now();
	const fragment = document.createDocumentFragment();

	for (let n = 0; n < BATCH_SIZE && generatedCount < TOTAL_COLORS; n++) {
		const hex = indexToHex(generatedCount);
		const colorBox = document.createElement('div');

		colorBox.className = 'color-box';
		colorBox.style.backgroundColor = hex;
		colorBox.textContent = hex;
		colorBox.dataset.hex = hex;

		fragment.appendChild(colorBox);
		generatedCount++;
	}

	container.appendChild(fragment);

	// Update stats
	const lastHex = indexToHex(generatedCount - 1);
	if (lcg) lcg.textContent = lastHex;
	if (ncg) ncg.textContent = String(generatedCount);
	if (ncl) ncl.textContent = String(TOTAL_COLORS - generatedCount);

	// Handle smooth scrolling
	if (scrollTarget !== null) {
		const currentScroll = window.scrollY;
		const maxScroll = document.body.scrollHeight - window.innerHeight;

		if (currentScroll >= maxScroll - 10 || isComplete) {
			scrollTarget = null;
		} else if (generatedCount < TOTAL_COLORS) {
			// Keep scrolling as new content is added
			requestAnimationFrame(() => {
				window.scrollTo({ top: document.body.scrollHeight });
			});
		}
	}

	// Calculate ETA
	const elapsed = (performance.now() - start) / 1000;
	const rate = BATCH_SIZE / elapsed;
	rateHistory.push(rate);
	if (rateHistory.length > smoothingFrames) rateHistory.shift();

	const avgRate = rateHistory.reduce((a, b) => a + b, 0) / rateHistory.length;
	const remaining = (TOTAL_COLORS - generatedCount) / avgRate;
	if (tlEl) tlEl.textContent = formatTime(remaining);

	// Cleanup old elements periodically to prevent slowdown
	if (generatedCount % 10000 === 0) {
		cleanupOldElements();
	}

	// Continue generation
	if (generatedCount < TOTAL_COLORS) {
		requestAnimationFrame(generateColors);
	} else {
		isComplete = true;
		if (tlEl) tlEl.textContent = '00:00:00:00';
	}
}

generateColors();
</script>

<style>
	#color-container {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
		gap: 4px;
		padding: 8px;
	}

	.color-box {
		aspect-ratio: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		font-family: monospace;
		font-size: 10px;
		cursor: pointer;
		border-radius: 4px;
		transition: outline 0.15s ease;
		user-select: none;
		text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
	}

	.color-box:hover {
		outline: 2px solid white;
		transform: scale(1.05);
	}
</style>
